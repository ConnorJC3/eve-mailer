<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="referrer" content="no-referrer">
  <meta http-equiv="Content-Security-Policy" content="default-src 'none'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; img-src 'self'; connect-src https://login.eveonline.com https://esi.evetech.net">
  <title>EVEMAILER</title>
  <link rel="icon" type="image/webp" href="mail.webp">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Barlow:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    /* ── Dark-first theme: EVE command terminal ────────────────────────── */
    :root {
      --bg-deep: #060a13;
      --bg-primary: #0b1120;
      --bg-card: #0f1729;
      --bg-input: #0a1222;
      --bg-input-focus: #0d1830;
      --bg-hover: #152040;
      --border: #1a2a40;
      --border-subtle: #131f33;
      --glow-cyan: rgba(0, 190, 230, 0.18);
      --glow-accent: rgba(232, 112, 31, 0.25);
      --text-primary: #d0d8e4;
      --text-secondary: #94a8bc;
      --text-muted: #748da4;
      --text-bright: #eaf0f8;
      --accent: #e87820;
      --accent-hover: #f59035;
      --accent-subtle: rgba(232, 120, 32, 0.12);
      --cyan: #00bce6;
      --cyan-dim: rgba(0, 188, 230, 0.55);
      --cyan-subtle: rgba(0, 188, 230, 0.08);
      --success: #12c77a;
      --success-dim: rgba(18, 199, 122, 0.15);
      --error: #f04848;
      --error-dim: rgba(240, 72, 72, 0.15);
      --skip: #5a6a7d;
      --shadow: 0 2px 12px rgba(0, 0, 0, 0.5), 0 0 1px rgba(0, 188, 230, 0.1);
      --radius: 4px;
      --radius-lg: 6px;
    }

    @media (prefers-color-scheme: light) {
      :root {
        --bg-deep: #e6eaf0;
        --bg-primary: #edf1f6;
        --bg-card: #ffffff;
        --bg-input: #f2f5f9;
        --bg-input-focus: #ffffff;
        --bg-hover: #e4e9f0;
        --border: #c8d0dc;
        --border-subtle: #dbe1ea;
        --glow-cyan: rgba(8, 130, 165, 0.1);
        --glow-accent: rgba(200, 90, 10, 0.1);
        --text-primary: #1c2a3a;
        --text-secondary: #4d6178;
        --text-muted: #94a3b8;
        --text-bright: #0f1a28;
        --accent: #d06010;
        --accent-hover: #b35210;
        --accent-subtle: rgba(208, 96, 16, 0.08);
        --cyan: #0882a5;
        --cyan-dim: rgba(8, 130, 165, 0.45);
        --cyan-subtle: rgba(8, 130, 165, 0.06);
        --success: #0a8f55;
        --success-dim: rgba(10, 143, 85, 0.1);
        --error: #cc2e2e;
        --error-dim: rgba(204, 46, 46, 0.08);
        --skip: #6b7b8e;
        --shadow: 0 1px 4px rgba(0, 0, 0, 0.06), 0 0 0 1px rgba(0, 0, 0, 0.03);
      }
    }

    /* ── Reset ──────────────────────────────────────────────────────────── */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    /* ── Body / page ───────────────────────────────────────────────────── */
    body {
      font-family: 'Barlow', sans-serif;
      font-weight: 400;
      background: radial-gradient(ellipse 120% 80% at 50% 0%, var(--bg-primary) 0%, var(--bg-deep) 100%);
      background-attachment: fixed;
      color: var(--text-primary);
      line-height: 1.55;
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
    }

    /* ── Accent bar at the very top ────────────────────────────────────── */
    body::before {
      content: '';
      display: block;
      height: 2px;
      background: linear-gradient(90deg, transparent 5%, var(--cyan) 30%, var(--accent) 50%, var(--cyan) 70%, transparent 95%);
      opacity: 0.6;
    }

    /* ── Header ────────────────────────────────────────────────────────── */
    header {
      max-width: 820px;
      margin: 0 auto;
      padding: 1.25rem 1.5rem 0.75rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
    }

    header h1 {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-family: 'Rajdhani', sans-serif;
      font-weight: 700;
      font-size: 1.5rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      background: linear-gradient(135deg, #f0c040 0%, #ffe680 60%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    header h1 img {
      flex-shrink: 0;
      height: 1.35em;
      width: auto;
    }

    #auth-area {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 0.85rem;
    }

    #char-name {
      font-family: 'Rajdhani', sans-serif;
      font-weight: 600;
      font-size: 0.95rem;
      color: var(--cyan);
      letter-spacing: 0.03em;
    }

    /* ── Main ──────────────────────────────────────────────────────────── */
    main {
      max-width: 820px;
      margin: 0 auto;
      padding: 0 1.5rem 2.5rem;
    }

    /* ── Cards ─────────────────────────────────────────────────────────── */
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      box-shadow: var(--shadow);
      margin-bottom: 1rem;
      position: relative;
    }

    .card::before {
      content: '';
      position: absolute;
      inset: -1px;
      border-radius: var(--radius-lg);
      border: 1px solid transparent;
      background: linear-gradient(180deg, var(--glow-cyan), transparent 60%) border-box;
      -webkit-mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      pointer-events: none;
    }

    .card h2 {
      font-family: 'Rajdhani', sans-serif;
      font-weight: 600;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-secondary);
      margin-bottom: 1.25rem;
      padding-bottom: 0.6rem;
      border-bottom: 1px solid var(--border-subtle);
    }

    /* ── Form elements ─────────────────────────────────────────────────── */
    .form-group {
      margin-bottom: 1rem;
    }

    .form-group label {
      display: block;
      font-family: 'Rajdhani', sans-serif;
      font-weight: 500;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-secondary);
      margin-bottom: 0.35rem;
    }

    .form-group label small {
      font-family: 'Barlow', sans-serif;
      text-transform: none;
      letter-spacing: normal;
      font-weight: 400;
      color: var(--text-muted);
    }

    input[type="text"], textarea {
      width: 100%;
      padding: 0.55rem 0.75rem;
      background: var(--bg-input);
      color: var(--text-primary);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-family: 'Barlow', sans-serif;
      font-size: 0.875rem;
      line-height: 1.55;
      transition: border-color 0.2s, background-color 0.2s, box-shadow 0.2s;
    }

    input[type="text"]:focus, textarea:focus {
      outline: none;
      border-color: var(--cyan-dim);
      background: var(--bg-input-focus);
      box-shadow: 0 0 0 2px var(--glow-cyan);
    }

    textarea { resize: vertical; }

    input[type="text"]:disabled, textarea:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    /* ── Buttons ───────────────────────────────────────────────────────── */
    button {
      font-family: 'Rajdhani', sans-serif;
      font-weight: 600;
      font-size: 0.85rem;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      padding: 0.5rem 1.15rem;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      transition: background-color 0.15s, box-shadow 0.2s, opacity 0.15s, transform 0.1s;
    }

    button:active:not(:disabled) { transform: scale(0.97); }
    button:disabled { opacity: 0.35; cursor: not-allowed; }

    #btn-login, #btn-send {
      background: var(--accent);
      color: #fff;
    }

    #btn-login:hover:not(:disabled), #btn-send:hover:not(:disabled) {
      background: var(--accent-hover);
      box-shadow: 0 0 16px var(--glow-accent);
    }

    .btn-secondary {
      background: var(--cyan-subtle);
      color: var(--cyan);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover:not(:disabled) {
      background: var(--glow-cyan);
      border-color: var(--cyan-dim);
      box-shadow: 0 0 12px var(--glow-cyan);
    }

    .btn-danger {
      background: var(--error-dim);
      color: var(--error);
      border: 1px solid var(--border);
    }

    .btn-danger:hover:not(:disabled) {
      background: var(--error);
      color: #fff;
      border-color: var(--error);
    }

    #btn-logout {
      background: transparent;
      color: var(--text-secondary);
      border: 1px solid var(--border);
      padding: 0.3rem 0.8rem;
      font-size: 0.75rem;
    }

    #btn-logout:hover { border-color: var(--text-secondary); color: var(--text-primary); }

    /* ── Template section ──────────────────────────────────────────────── */
    .template-section {
      margin-bottom: 1.25rem;
      padding-bottom: 1.25rem;
      border-bottom: 1px solid var(--border-subtle);
    }

    .template-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 0.45rem;
      margin-top: 0.75rem;
      min-height: 0;
    }

    .template-chips:empty {
      margin-top: 0;
    }

    .template-chip {
      display: inline-flex;
      align-items: stretch;
      background: var(--cyan-subtle);
      border: 1px solid var(--border);
      border-radius: 2px;
      overflow: hidden;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .template-chip:hover {
      border-color: var(--cyan-dim);
      box-shadow: 0 0 8px var(--glow-cyan);
    }

    .template-chip-label {
      padding: 0.2rem 0.6rem;
      cursor: pointer;
      font-family: 'Rajdhani', sans-serif;
      font-weight: 500;
      font-size: 0.8rem;
      letter-spacing: 0.03em;
      color: var(--text-primary);
      transition: background 0.15s;
    }

    .template-chip-label:hover {
      background: var(--glow-cyan);
    }

    .template-chip-delete {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 1.6rem;
      background: none;
      border: none;
      border-left: 1px solid var(--border);
      color: var(--text-muted);
      cursor: pointer;
      font-size: 0.7rem;
      padding: 0;
      line-height: 1;
      border-radius: 0;
      text-transform: none;
      letter-spacing: 0;
      font-family: 'Barlow', sans-serif;
      font-weight: 400;
      transition: background 0.15s, color 0.15s;
    }

    .template-chip-delete:hover {
      background: var(--error);
      color: #fff;
    }

    .template-controls {
      display: flex;
      gap: 0.5rem;
    }

    .template-controls input {
      flex: 1;
      min-width: 0;
    }

    /* ── Actions bar ───────────────────────────────────────────────────── */
    .form-actions {
      display: flex;
      gap: 0.75rem;
      margin-top: 1.5rem;
    }

    #btn-send {
      padding: 0.6rem 1.75rem;
      font-size: 0.9rem;
    }

    #btn-send.armed,
    #btn-send.armed:hover:not(:disabled) {
      background: var(--error);
      box-shadow: 0 0 18px rgba(240, 72, 72, 0.4);
      animation: armPulse 1s ease-in-out infinite;
    }

    @keyframes armPulse {
      0%, 100% { box-shadow: 0 0 12px rgba(240, 72, 72, 0.3); }
      50%      { box-shadow: 0 0 22px rgba(240, 72, 72, 0.55); }
    }

    /* ── Error banner ──────────────────────────────────────────────────── */
    .error-banner[hidden] { display: none; }

    .error-banner {
      background: var(--error-dim);
      border: 1px solid var(--error);
      color: var(--error);
      padding: 0.6rem 1rem;
      border-radius: var(--radius);
      margin-bottom: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      font-size: 0.85rem;
      animation: bannerIn 0.25s ease-out;
    }

    @keyframes bannerIn {
      from { opacity: 0; transform: translateY(-6px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .error-banner button {
      background: none;
      color: var(--error);
      font-size: 1.1rem;
      padding: 0.1rem 0.3rem;
      line-height: 1;
      opacity: 0.7;
      text-transform: none;
      letter-spacing: 0;
    }

    .error-banner button:hover { opacity: 1; }

    /* ── Progress section ──────────────────────────────────────────────── */
    #progress-summary {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.75rem;
      font-weight: 400;
      color: var(--text-secondary);
      margin-bottom: 0.6rem;
      letter-spacing: 0.02em;
    }

    .progress-bar-track {
      height: 3px;
      background: var(--border);
      border-radius: 2px;
      overflow: hidden;
      margin-bottom: 0.75rem;
    }

    .progress-bar-fill {
      height: 100%;
      width: 0%;
      border-radius: 2px;
      background: linear-gradient(90deg, var(--accent) 0%, #f0983a 45%, var(--accent) 100%);
      background-size: 200% 100%;
      animation: barShimmer 2s ease-in-out infinite;
      transition: width 0.35s ease;
    }

    @keyframes barShimmer {
      0%   { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    .progress-bar-fill.done-success {
      background: var(--success);
      animation: none;
    }

    .progress-bar-fill.done-error {
      background: var(--error);
      animation: none;
    }

    /* ── Send log ──────────────────────────────────────────────────────── */
    .send-log {
      max-height: 340px;
      overflow-y: auto;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--bg-input);
    }

    .send-log::-webkit-scrollbar { width: 4px; }
    .send-log::-webkit-scrollbar-track { background: transparent; }
    .send-log::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

    .log-entry {
      display: flex;
      align-items: baseline;
      gap: 0.5rem;
      padding: 0.3rem 0.65rem;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.75rem;
      border-bottom: 1px solid var(--border-subtle);
      border-left: 2px solid transparent;
      animation: logSlide 0.2s ease-out;
    }

    @keyframes logSlide {
      from { opacity: 0; transform: translateX(-6px); }
      to   { opacity: 1; transform: translateX(0); }
    }

    .log-entry:last-child { border-bottom: none; }

    .log-entry::before {
      flex-shrink: 0;
      font-size: 0.65rem;
    }

    .log-pending  { border-left-color: var(--text-muted); }
    .log-sending  { border-left-color: var(--accent); }
    .log-success  { border-left-color: var(--success); }
    .log-error    { border-left-color: var(--error); }
    .log-skip     { border-left-color: var(--skip); }
    .log-cancel   { border-left-color: var(--skip); }
    .log-info     { border-left-color: var(--cyan); }

    .log-pending::before  { content: '\25CB'; color: var(--text-muted); }
    .log-sending::before  { content: '\25CF'; color: var(--accent); }
    .log-success::before  { content: '\2713'; color: var(--success); }
    .log-error::before    { content: '\2717'; color: var(--error); }
    .log-skip::before     { content: '\2014'; color: var(--skip); }
    .log-cancel::before   { content: '\2298'; color: var(--skip); }
    .log-info::before     { content: '\25B8'; color: var(--cyan); }

    .log-name {
      font-weight: 500;
      white-space: nowrap;
      color: var(--text-bright);
    }

    .log-msg {
      color: var(--text-secondary);
    }

    /* ── Footer ────────────────────────────────────────────────────────── */
    footer {
      max-width: 820px;
      margin: 0 auto;
      padding: 0.5rem 1.5rem 2rem;
      text-align: center;
      font-size: 0.7rem;
      color: var(--text-muted);
      letter-spacing: 0.02em;
      line-height: 1.6;
    }

    footer a {
      color: var(--text-secondary);
      text-decoration: none;
    }

    footer a:hover {
      color: var(--text-primary);
      text-decoration: underline;
    }

    /* ── Responsive ────────────────────────────────────────────────────── */
    @media (max-width: 640px) {
      header {
        flex-direction: column;
        align-items: flex-start;
        padding: 1rem;
      }
      main { padding: 0 1rem 2rem; }
      .card { padding: 1.15rem; }
      .template-controls { flex-direction: column; }
      .form-actions { flex-direction: column; }
      .form-actions button { width: 100%; }
    }
  </style>
</head>
<body>
  <header>
    <h1><img src="mail.webp" alt="">EVEMAILER</h1>
    <div id="auth-area">
      <span id="char-name" hidden></span>
      <button id="btn-login">Login with EVE SSO</button>
      <button id="btn-logout" hidden>Logout</button>
    </div>
  </header>

  <main>
    <div id="error-banner" class="error-banner" hidden>
      <span id="error-msg"></span>
      <button id="btn-dismiss-error" aria-label="Dismiss">&times;</button>
    </div>

    <section class="card" id="composer">
      <h2>Compose Mail</h2>

      <div class="template-section">
        <div class="template-controls">
          <input type="text" id="template-name" placeholder="Template name" />
          <button id="btn-save-template" class="btn-secondary">Save Template</button>
        </div>
        <div class="template-chips" id="template-chips"></div>
      </div>

      <div class="form-group">
        <label for="recipients">Recipients <small>(one character name per line)</small></label>
        <textarea id="recipients" rows="6"></textarea>
      </div>

      <div class="form-group">
        <label for="mail-subject">Subject</label>
        <input type="text" id="mail-subject" maxlength="1000" />
      </div>

      <div class="form-group">
        <label for="mail-body">Body</label>
        <textarea id="mail-body" rows="10"></textarea>
      </div>

      <div class="form-actions">
        <button id="btn-send" disabled>Send to All Recipients</button>
        <button id="btn-cancel" class="btn-danger" hidden>Cancel</button>
      </div>
    </section>

    <section class="card" id="progress-panel" hidden>
      <h2>Sending Progress</h2>
      <div id="progress-summary">Ready</div>
      <div class="progress-bar-track">
        <div id="progress-bar" class="progress-bar-fill"></div>
      </div>
      <div id="send-log" class="send-log"></div>
    </section>
  </main>

  <footer>
    <p>&copy; CCP hf. All rights reserved. &ldquo;EVE&rdquo;, &ldquo;EVE Online&rdquo;, &ldquo;CCP&rdquo;, and all related logos and images are trademarks or registered trademarks of CCP hf.</p>
    <p><a href="https://github.com/ConnorJC3/eve-mailer" target="_blank" rel="noopener">Source Code</a></p>
  </footer>

  <script>
  (function() {
    'use strict';

    // =========================================================================
    // CONFIGURATION — Set your EVE application Client ID here
    // =========================================================================
    const CLIENT_ID = '10bcb6daed354d2a9287abe4f5900dee';
    // =========================================================================

    const EVE_SSO_AUTH_URL = 'https://login.eveonline.com/v2/oauth/authorize';
    const EVE_SSO_TOKEN_URL = 'https://login.eveonline.com/v2/oauth/token';
    const ESI_BASE = 'https://esi.evetech.net/latest';
    const SCOPES = 'esi-mail.send_mail.v1 publicData';
    const SEND_DELAY_MS = 15000;
    const MAX_RETRIES = 3;
    const RETRY_BASE_MS = 2000;
    const TOKEN_REFRESH_BUFFER_MS = 120000;

    const LS = {
      refreshToken: 'eve-mailer-refresh',
      templates: 'eve-mailer-templates',
    };

    const SS = {
      codeVerifier: 'eve-mailer-verifier',
      ssoState: 'eve-mailer-state',
    };

    // =========================================================================
    // Utilities
    // =========================================================================

    function base64url(buffer) {
      var bytes = new Uint8Array(buffer);
      var binary = '';
      for (var i = 0; i < bytes.length; i++) binary += String.fromCharCode(bytes[i]);
      return btoa(binary).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    }

    function base64urlDecode(str) {
      str = str.replace(/-/g, '+').replace(/_/g, '/');
      while (str.length % 4) str += '=';
      return atob(str);
    }

    function sleep(ms) {
      return new Promise(function(resolve) { setTimeout(resolve, ms); });
    }

    function randomHex(bytes) {
      var arr = crypto.getRandomValues(new Uint8Array(bytes));
      return Array.from(arr, function(b) { return b.toString(16).padStart(2, '0'); }).join('');
    }

    function lsGet(key) {
      try { return localStorage.getItem(key); } catch (e) { return null; }
    }

    function lsSet(key, val) {
      try { localStorage.setItem(key, val); } catch (e) { /* ignored */ }
    }

    function lsRemove(key) {
      try { localStorage.removeItem(key); } catch (e) { /* ignored */ }
    }

    function ssGet(key) {
      try { return sessionStorage.getItem(key); } catch (e) { return null; }
    }

    function ssSet(key, val) {
      try { sessionStorage.setItem(key, val); } catch (e) { /* ignored */ }
    }

    function ssRemove(key) {
      try { sessionStorage.removeItem(key); } catch (e) { /* ignored */ }
    }

    // =========================================================================
    // SSO Module
    // =========================================================================

    var SSO = {
      accessToken: null,
      refreshTokenValue: null,
      tokenExpiresAt: 0,
      characterId: null,
      characterName: null,
      _refreshTimer: null,

      generateCodeVerifier: function() {
        var arr = crypto.getRandomValues(new Uint8Array(32));
        return base64url(arr.buffer);
      },

      generateCodeChallenge: async function(verifier) {
        var encoded = new TextEncoder().encode(verifier);
        var digest = await crypto.subtle.digest('SHA-256', encoded);
        return base64url(digest);
      },

      startLogin: async function() {
        if (CLIENT_ID === 'YOUR_CLIENT_ID_HERE') {
          UI.showError('Set CLIENT_ID in the source code before logging in.');
          return;
        }
        var verifier = this.generateCodeVerifier();
        ssSet(SS.codeVerifier, verifier);

        var challenge = await this.generateCodeChallenge(verifier);
        var state = randomHex(16);
        ssSet(SS.ssoState, state);

        var redirectUri = window.location.origin + window.location.pathname;
        var params = new URLSearchParams({
          response_type: 'code',
          redirect_uri: redirectUri,
          client_id: CLIENT_ID,
          scope: SCOPES,
          code_challenge: challenge,
          code_challenge_method: 'S256',
          state: state,
        });
        window.location.href = EVE_SSO_AUTH_URL + '?' + params.toString();
      },

      handleCallback: async function() {
        var params = new URLSearchParams(window.location.search);

        if (params.has('error')) {
          var errDesc = params.get('error_description') || params.get('error');
          history.replaceState(null, '', window.location.pathname);
          throw new Error('SSO error: ' + errDesc);
        }

        var code = params.get('code');
        var state = params.get('state');
        var storedState = ssGet(SS.ssoState);
        var verifier = ssGet(SS.codeVerifier);

        history.replaceState(null, '', window.location.pathname);

        if (!code || !state) throw new Error('Missing authorization code or state.');
        if (state !== storedState) throw new Error('State mismatch — possible CSRF. Please try again.');
        if (!verifier) throw new Error('Missing code verifier. Please try logging in again.');

        ssRemove(SS.codeVerifier);
        ssRemove(SS.ssoState);

        await this.exchangeToken(code, verifier);
      },

      exchangeToken: async function(code, verifier) {
        var body = new URLSearchParams({
          grant_type: 'authorization_code',
          code: code,
          client_id: CLIENT_ID,
          code_verifier: verifier,
        });

        var resp;
        try {
          resp = await fetch(EVE_SSO_TOKEN_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: body.toString(),
          });
        } catch (e) {
          throw new Error('Token exchange network error. CORS may be blocking the request. Details: ' + e.message);
        }

        if (!resp.ok) {
          var errBody;
          try { errBody = await resp.json(); } catch (_) { errBody = {}; }
          throw new Error('Token exchange failed (' + resp.status + '): ' + (errBody.error_description || errBody.error || resp.statusText));
        }

        var data = await resp.json();
        this.processTokenResponse(data);
      },

      refreshAccessToken: async function() {
        var rt = this.refreshTokenValue || lsGet(LS.refreshToken);
        if (!rt) throw new Error('No refresh token available. Please log in again.');

        var body = new URLSearchParams({
          grant_type: 'refresh_token',
          refresh_token: rt,
          client_id: CLIENT_ID,
        });

        var lastErr;
        for (var attempt = 0; attempt < 3; attempt++) {
          try {
            var resp = await fetch(EVE_SSO_TOKEN_URL, {
              method: 'POST',
              headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
              body: body.toString(),
            });

            if (resp.ok) {
              var data = await resp.json();
              this.processTokenResponse(data);
              return;
            }

            if (resp.status === 400 || resp.status === 401) {
              this.clearAuthState();
              var authErr = new Error('Session expired. Please log in again.');
              authErr.authFailure = true;
              throw authErr;
            }

            if (resp.status === 429) {
              var retryAfter = parseInt(resp.headers.get('retry-after') || '30', 10);
              await sleep(retryAfter * 1000);
              continue;
            }

            lastErr = new Error('Refresh failed: ' + resp.status);
          } catch (e) {
            if (e.authFailure) throw e;
            lastErr = e;
          }
          if (attempt < 2) await sleep(2000);
        }
        throw lastErr || new Error('Token refresh failed after retries.');
      },

      processTokenResponse: function(data) {
        this.accessToken = data.access_token;
        this.tokenExpiresAt = Date.now() + data.expires_in * 1000;

        if (data.refresh_token) {
          this.refreshTokenValue = data.refresh_token;
          lsSet(LS.refreshToken, data.refresh_token);
        }

        var payload = this.decodeJwtPayload(data.access_token);
        if (payload.sub) {
          var parts = payload.sub.split(':');
          this.characterId = parseInt(parts[2], 10);
        }
        this.characterName = payload.name || 'Unknown';

        this.scheduleTokenRefresh();
      },

      decodeJwtPayload: function(jwt) {
        try {
          var parts = jwt.split('.');
          var decoded = base64urlDecode(parts[1]);
          return JSON.parse(decoded);
        } catch (e) {
          return {};
        }
      },

      ensureValidToken: async function() {
        if (!this.accessToken && !this.refreshTokenValue && !lsGet(LS.refreshToken)) {
          throw new Error('Not authenticated. Please log in.');
        }
        if (!this.accessToken || this.tokenExpiresAt - Date.now() < TOKEN_REFRESH_BUFFER_MS) {
          await this.refreshAccessToken();
        }
        return this.accessToken;
      },

      scheduleTokenRefresh: function() {
        if (this._refreshTimer) clearTimeout(this._refreshTimer);
        var delay = this.tokenExpiresAt - Date.now() - TOKEN_REFRESH_BUFFER_MS;
        if (delay < 0) delay = 0;
        var self = this;
        this._refreshTimer = setTimeout(function() {
          self.refreshAccessToken().catch(function(err) {
            if (err.authFailure) UI.showLoggedOut();
          });
        }, delay);
      },

      clearAuthState: function() {
        this.accessToken = null;
        this.refreshTokenValue = null;
        this.tokenExpiresAt = 0;
        this.characterId = null;
        this.characterName = null;
        if (this._refreshTimer) clearTimeout(this._refreshTimer);
        lsRemove(LS.refreshToken);
      },

      logout: function() {
        this.clearAuthState();
        ssRemove(SS.codeVerifier);
        ssRemove(SS.ssoState);
        UI.showLoggedOut();
      },

      isAuthenticated: function() {
        return !!(this.accessToken && this.tokenExpiresAt > Date.now());
      },
    };

    // =========================================================================
    // ESI Module
    // =========================================================================

    var ESI = {
      errorLimitRemain: 100,
      errorLimitResetAt: 0,

      request: async function(url, options, retryCount) {
        if (retryCount === undefined) retryCount = 0;

        if (this.errorLimitRemain < 10 && this.errorLimitResetAt > Date.now()) {
          var waitMs = this.errorLimitResetAt - Date.now() + 1000;
          await sleep(waitMs);
        }

        var resp;
        try {
          resp = await fetch(url, options);
        } catch (e) {
          if (retryCount < MAX_RETRIES) {
            await sleep(3000 * Math.pow(2, retryCount));
            return this.request(url, options, retryCount + 1);
          }
          throw new Error('Network error: ' + e.message);
        }

        var remain = resp.headers.get('x-esi-error-limit-remain');
        var reset = resp.headers.get('x-esi-error-limit-reset');
        if (remain !== null) this.errorLimitRemain = parseInt(remain, 10);
        if (reset !== null) this.errorLimitResetAt = Date.now() + parseInt(reset, 10) * 1000;

        if (resp.ok) return resp;

        var errBody;
        try { errBody = await resp.json(); } catch (_) { errBody = { error: resp.statusText }; }
        var errMsg = errBody.error || errBody.message || resp.statusText;
        var status = resp.status;

        if (status === 400 || status === 403 || status === 404) {
          throw new ESIError(status, errMsg, errBody);
        }

        if (status === 401 && retryCount === 0) {
          await SSO.refreshAccessToken();
          if (options.headers) options.headers['Authorization'] = 'Bearer ' + SSO.accessToken;
          return this.request(url, options, 1);
        }

        if (retryCount >= MAX_RETRIES) {
          throw new ESIError(status, errMsg + ' (after ' + MAX_RETRIES + ' retries)', errBody);
        }

        if (status === 420) {
          var resetSec = parseInt(reset, 10) || 60;
          await sleep(resetSec * 1000 + 1000);
          return this.request(url, options, retryCount + 1);
        }

        if (status === 429) {
          var retryAfter = parseInt(resp.headers.get('retry-after') || '60', 10);
          await sleep(retryAfter * 1000 + 1000);
          return this.request(url, options, retryCount + 1);
        }

        if (status === 520) {
          var delays520 = [15000, 30000, 60000];
          await sleep(delays520[retryCount] || 60000);
          return this.request(url, options, retryCount + 1);
        }

        await sleep(RETRY_BASE_MS * Math.pow(2, retryCount));
        return this.request(url, options, retryCount + 1);
      },

      resolveNames: async function(names) {
        var resolved = new Map();
        var notFound = [];

        for (var i = 0; i < names.length; i += 500) {
          var batch = names.slice(i, i + 500);
          var characters = [];
          try {
            var resp = await this.request(ESI_BASE + '/universe/ids/', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(batch),
            });
            var data = await resp.json();
            characters = data.characters || [];
          } catch (e) {
            if (e.status === 404) {
              characters = [];
            } else {
              throw e;
            }
          }

          var foundLower = new Set();
          for (var c = 0; c < characters.length; c++) {
            var ch = characters[c];
            foundLower.add(ch.name.toLowerCase());
            resolved.set(ch.name.toLowerCase(), { id: ch.id, name: ch.name });
          }

          for (var j = 0; j < batch.length; j++) {
            if (!foundLower.has(batch[j].toLowerCase())) {
              notFound.push(batch[j]);
            }
          }
        }

        return { resolved: resolved, notFound: notFound };
      },

      sendMail: async function(characterId, accessToken, recipientId, subject, body) {
        var resp = await this.request(ESI_BASE + '/characters/' + characterId + '/mail/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + accessToken,
          },
          body: JSON.stringify({
            recipients: [{ recipient_id: recipientId, recipient_type: 'character' }],
            subject: subject,
            body: body,
            approved_cost: 0,
          }),
        });
        return await resp.json();
      },
    };

    function ESIError(status, message, body) {
      this.name = 'ESIError';
      this.status = status;
      this.message = message;
      this.body = body;
    }
    ESIError.prototype = Object.create(Error.prototype);
    ESIError.prototype.constructor = ESIError;

    // =========================================================================
    // Templates Module
    // =========================================================================

    var Templates = {
      getAll: function() {
        try {
          var raw = lsGet(LS.templates);
          return raw ? JSON.parse(raw) : [];
        } catch (e) {
          return [];
        }
      },

      save: function(name, subject, body) {
        var all = this.getAll();
        var idx = all.findIndex(function(t) { return t.name === name; });
        if (idx >= 0) {
          all[idx] = { name: name, subject: subject, body: body };
        } else {
          all.push({ name: name, subject: subject, body: body });
        }
        lsSet(LS.templates, JSON.stringify(all));
      },

      load: function(name) {
        var all = this.getAll();
        return all.find(function(t) { return t.name === name; }) || null;
      },

      remove: function(name) {
        var all = this.getAll().filter(function(t) { return t.name !== name; });
        lsSet(LS.templates, JSON.stringify(all));
      },

      getNames: function() {
        return this.getAll().map(function(t) { return t.name; });
      },
    };

    // =========================================================================
    // Mail Module
    // =========================================================================

    var Mail = {
      isSending: false,
      isCancelled: false,
      stats: { total: 0, sent: 0, failed: 0, skipped: 0 },

      sendAll: async function(rawText, subject, body) {
        subject = subject.trim();
        body = body.trim();
        if (!subject) { UI.showError('Subject is required.'); return; }
        if (!body) { UI.showError('Body is required.'); return; }

        var lines = rawText.split('\n');
        var seen = new Set();
        var names = [];
        for (var i = 0; i < lines.length; i++) {
          var trimmed = lines[i].trim();
          if (!trimmed) continue;
          var lower = trimmed.toLowerCase();
          if (seen.has(lower)) continue;
          seen.add(lower);
          names.push(trimmed);
        }

        if (names.length === 0) { UI.showError('Enter at least one recipient.'); return; }

        this.isSending = true;
        this.isCancelled = false;
        this.stats = { total: names.length, sent: 0, failed: 0, skipped: 0 };
        UI.setSending(true);
        UI.showProgressPanel();
        UI.clearLog();
        UI.updateProgress(this.stats);

        try {
          UI.addLogEntry('SYSTEM', 'Resolving ' + names.length + ' character name(s)\u2026', 'info');
          var result = await ESI.resolveNames(names);

          for (var n = 0; n < result.notFound.length; n++) {
            this.stats.skipped++;
            UI.addLogEntry(result.notFound[n], 'Character not found', 'skip');
          }
          UI.updateProgress(this.stats);

          var sendList = [];
          for (var k = 0; k < names.length; k++) {
            var entry = result.resolved.get(names[k].toLowerCase());
            if (entry) sendList.push(entry);
          }

          if (sendList.length === 0) {
            UI.addLogEntry('SYSTEM', 'No valid recipients found.', 'error');
            return;
          }

          UI.addLogEntry('SYSTEM', 'Sending to ' + sendList.length + ' recipient(s)\u2026', 'info');

          for (var s = 0; s < sendList.length; s++) {
            if (this.isCancelled) {
              for (var r = s; r < sendList.length; r++) {
                this.stats.skipped++;
                UI.addLogEntry(sendList[r].name, 'Cancelled', 'cancel');
              }
              UI.updateProgress(this.stats);
              break;
            }

            var recipient = sendList[s];
            UI.addLogEntry(recipient.name, 'Sending\u2026', 'sending');

            try {
              var token = await SSO.ensureValidToken();
              await ESI.sendMail(SSO.characterId, token, recipient.id, subject, body);
              this.stats.sent++;
              UI.updateLogEntry(recipient.name, 'Sent', 'success');
            } catch (e) {
              if (e.body && e.body.error && /self/i.test(e.body.error)) {
                this.stats.skipped++;
                UI.updateLogEntry(recipient.name, 'Cannot send to self', 'skip');
              } else if (e.authFailure || (e.message && /Not authenticated|log in/i.test(e.message))) {
                this.stats.failed++;
                UI.updateLogEntry(recipient.name, e.message, 'error');
                UI.showError('Authentication lost. Aborting send.');
                break;
              } else {
                this.stats.failed++;
                UI.updateLogEntry(recipient.name, e.message || 'Unknown error', 'error');
              }
            }

            UI.updateProgress(this.stats);

            if (s < sendList.length - 1 && !this.isCancelled) {
              await sleep(SEND_DELAY_MS);
            }
          }
        } catch (e) {
          UI.addLogEntry('SYSTEM', e.message || 'Unexpected error', 'error');
        } finally {
          this.isSending = false;
          UI.setSending(false);
          UI.finishProgress(this.stats);
        }
      },

      cancel: function() {
        this.isCancelled = true;
      },
    };

    // =========================================================================
    // UI Module
    // =========================================================================

    var els = {};
    var logEntries = new Map();

    var UI = {
      init: function() {
        els.charName = document.getElementById('char-name');
        els.btnLogin = document.getElementById('btn-login');
        els.btnLogout = document.getElementById('btn-logout');
        els.errorBanner = document.getElementById('error-banner');
        els.errorMsg = document.getElementById('error-msg');
        els.btnDismissError = document.getElementById('btn-dismiss-error');
        els.templateChips = document.getElementById('template-chips');
        els.templateName = document.getElementById('template-name');
        els.btnSaveTemplate = document.getElementById('btn-save-template');
        els.recipients = document.getElementById('recipients');
        els.mailSubject = document.getElementById('mail-subject');
        els.mailBody = document.getElementById('mail-body');
        els.btnSend = document.getElementById('btn-send');
        els.btnCancel = document.getElementById('btn-cancel');
        els.progressPanel = document.getElementById('progress-panel');
        els.progressSummary = document.getElementById('progress-summary');
        els.progressBar = document.getElementById('progress-bar');
        els.sendLog = document.getElementById('send-log');

        els.btnLogin.addEventListener('click', function() { SSO.startLogin(); });
        els.btnLogout.addEventListener('click', function() { SSO.logout(); });
        els.btnDismissError.addEventListener('click', function() { UI.clearError(); });
        els.btnSaveTemplate.addEventListener('click', function() { UI.handleSaveTemplate(); });
        els.btnSend.addEventListener('click', function() { UI.handleSendClick(); });
        els.btnCancel.addEventListener('click', function() { Mail.cancel(); });

        document.addEventListener('click', function(e) {
          if (e.target !== els.btnSend && !els.btnSend.contains(e.target)) {
            UI.disarmSend();
          }
        });
        document.addEventListener('focusin', function(e) {
          if (e.target !== els.btnSend) {
            UI.disarmSend();
          }
        });
      },

      showLoggedIn: function(name) {
        els.charName.textContent = name;
        els.charName.hidden = false;
        els.btnLogin.hidden = true;
        els.btnLogout.hidden = false;
        els.btnSend.disabled = false;
      },

      showLoggedOut: function() {
        els.charName.hidden = true;
        els.btnLogin.hidden = false;
        els.btnLogin.disabled = false;
        els.btnLogin.textContent = 'Login with EVE SSO';
        els.btnLogout.hidden = true;
        els.btnSend.disabled = true;
      },

      showAuthenticating: function() {
        els.btnLogin.disabled = true;
        els.btnLogin.textContent = 'Authenticating\u2026';
      },

      showError: function(msg) {
        els.errorMsg.textContent = msg;
        els.errorBanner.hidden = false;
      },

      clearError: function() {
        els.errorBanner.hidden = true;
      },

      populateTemplateChips: function() {
        els.templateChips.innerHTML = '';
        var names = Templates.getNames();
        for (var i = 0; i < names.length; i++) {
          (function(name) {
            var chip = document.createElement('span');
            chip.className = 'template-chip';

            var label = document.createElement('span');
            label.className = 'template-chip-label';
            label.textContent = name;
            label.addEventListener('click', function() {
              var tmpl = Templates.load(name);
              if (tmpl) {
                els.mailSubject.value = tmpl.subject;
                els.mailBody.value = tmpl.body;
              }
            });

            var del = document.createElement('button');
            del.className = 'template-chip-delete';
            del.textContent = '\u00d7';
            del.title = 'Delete template';
            del.addEventListener('click', function(e) {
              e.stopPropagation();
              if (confirm('Delete template "' + name + '"?')) {
                Templates.remove(name);
                UI.populateTemplateChips();
              }
            });

            chip.appendChild(label);
            chip.appendChild(del);
            els.templateChips.appendChild(chip);
          })(names[i]);
        }
      },

      handleSaveTemplate: function() {
        var name = els.templateName.value.trim();
        if (!name) { UI.showError('Enter a template name.'); return; }
        var subject = els.mailSubject.value;
        var body = els.mailBody.value;
        var existing = Templates.load(name);
        if (existing && !confirm('Overwrite template "' + name + '"?')) return;
        Templates.save(name, subject, body);
        els.templateName.value = '';
        UI.populateTemplateChips();
      },

      _sendArmed: false,
      _armTimer: null,

      handleSendClick: function() {
        if (Mail.isSending) return;
        if (!this._sendArmed) {
          this.armSend();
        } else {
          this.disarmSend();
          Mail.sendAll(els.recipients.value, els.mailSubject.value, els.mailBody.value)
            .catch(function(e) { UI.showError(e.message); });
        }
      },

      armSend: function() {
        this._sendArmed = true;
        els.btnSend.style.minWidth = els.btnSend.offsetWidth + 'px';
        els.btnSend.classList.add('armed');
        els.btnSend.textContent = 'Confirm Send';
        if (this._armTimer) clearTimeout(this._armTimer);
        this._armTimer = setTimeout(function() { UI.disarmSend(); }, 10000);
      },

      disarmSend: function() {
        if (!this._sendArmed) return;
        this._sendArmed = false;
        els.btnSend.classList.remove('armed');
        els.btnSend.style.minWidth = '';
        els.btnSend.textContent = 'Send to All Recipients';
        if (this._armTimer) { clearTimeout(this._armTimer); this._armTimer = null; }
      },

      setSending: function(isSending) {
        this.disarmSend();
        els.btnSend.disabled = isSending || !SSO.isAuthenticated();
        els.btnCancel.hidden = !isSending;
        els.recipients.disabled = isSending;
        els.mailSubject.disabled = isSending;
        els.mailBody.disabled = isSending;
      },

      showProgressPanel: function() {
        els.progressPanel.hidden = false;
        els.progressBar.className = 'progress-bar-fill';
        els.progressBar.style.width = '0%';
      },

      clearLog: function() {
        els.sendLog.innerHTML = '';
        logEntries.clear();
      },

      addLogEntry: function(name, msg, status) {
        var entry = document.createElement('div');
        entry.className = 'log-entry log-' + status;

        var nameSpan = document.createElement('span');
        nameSpan.className = 'log-name';
        nameSpan.textContent = name;

        var msgSpan = document.createElement('span');
        msgSpan.className = 'log-msg';
        msgSpan.textContent = ' \u2014 ' + msg;

        entry.appendChild(nameSpan);
        entry.appendChild(msgSpan);
        els.sendLog.appendChild(entry);
        entry.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

        logEntries.set(name, { el: entry, msgSpan: msgSpan });
      },

      updateLogEntry: function(name, msg, status) {
        var data = logEntries.get(name);
        if (!data) return;
        data.el.className = 'log-entry log-' + status;
        data.msgSpan.textContent = ' \u2014 ' + msg;
        data.el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      },

      updateProgress: function(stats) {
        var done = stats.sent + stats.failed + stats.skipped;
        var pct = stats.total > 0 ? Math.round(done / stats.total * 100) : 0;
        els.progressBar.style.width = pct + '%';
        els.progressSummary.textContent =
          done + ' / ' + stats.total +
          '  \u2502  sent ' + stats.sent +
          '  \u2502  failed ' + stats.failed +
          '  \u2502  skipped ' + stats.skipped;
      },

      finishProgress: function(stats) {
        this.updateProgress(stats);
        if (stats.failed === 0 && stats.sent > 0) {
          els.progressBar.classList.add('done-success');
        } else if (stats.sent === 0 && stats.failed > 0) {
          els.progressBar.classList.add('done-error');
        }
      },
    };

    // =========================================================================
    // Initialization
    // =========================================================================

    document.addEventListener('DOMContentLoaded', function() {
      UI.init();
      UI.populateTemplateChips();

      var params = new URLSearchParams(window.location.search);

      if (params.has('code') || params.has('error')) {
        UI.showAuthenticating();
        SSO.handleCallback()
          .then(function() {
            UI.showLoggedIn(SSO.characterName);
          })
          .catch(function(err) {
            UI.showError(err.message);
            UI.showLoggedOut();
          });
      } else if (lsGet(LS.refreshToken)) {
        UI.showAuthenticating();
        SSO.refreshAccessToken()
          .then(function() {
            UI.showLoggedIn(SSO.characterName);
          })
          .catch(function(err) {
            UI.showError(err.message || 'Could not restore session.');
            UI.showLoggedOut();
          });
      } else {
        UI.showLoggedOut();
      }
    });
  })();
  </script>
</body>
</html>
